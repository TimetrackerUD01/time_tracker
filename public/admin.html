<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</title>

    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Admin ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà">
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà - ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö">
    <meta name="theme-color" content="#1a237e">

    <!-- PWA Icons and Manifest -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/logo.png" type="image/png">
    <link rel="apple-touch-icon" href="/logo.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=K2D:wght@300;400;600;700&family=Kanit:wght@300;400;600;700&display=swap');

        * {
            font-family: 'K2D', sans-serif;
        }

        body {
            background: #f8f9fa;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .sidebar-header h6 {
            color: white;
            margin: 0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .sidebar-header .org-name {
            color: #bdc3c7;
            font-size: 0.75rem;
            margin-top: 5px;
        }

        .sidebar.collapsed .sidebar-header h6,
        .sidebar.collapsed .sidebar-header .org-name {
            display: none;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            margin-bottom: 5px;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .menu-link:hover,
        .menu-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #3498db;
        }

        .menu-link i {
            width: 20px;
            margin-right: 15px;
            text-align: center;
        }

        .sidebar.collapsed .menu-link span {
            display: none;
        }

        .sidebar.collapsed .menu-link {
            justify-content: center;
            padding: 12px;
        }

        .sidebar.collapsed .menu-link i {
            margin: 0;
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 80px;
        }

        /* Header */
        .top-header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #6c757d;
            cursor: pointer;
        }

        .page-title {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6c757d;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Cards */
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: none;
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 15px;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Export Panel */
        .export-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .export-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .form-control,
        .form-select {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px 15px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-export {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            color: white;
        }

        /* Working Employees */
        .working-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .employee-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .employee-time {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .status-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Employee Controls */
        .employee-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .employee-count {
            text-align: center;
            padding: 8px 0;
        }

        /* Pagination */
        #employeePagination .page-link {
            color: #2c3e50;
            border-color: #dee2e6;
        }

        #employeePagination .page-item.active .page-link {
            background-color: #2c3e50;
            border-color: #2c3e50;
        }

        #employeePagination .page-link:hover {
            color: #1a252f;
            background-color: #e9ecef;
            border-color: #dee2e6;
        }

        /* Employee Item Animation */
        .employee-item {
            transition: all 0.3s ease;
        }

        .employee-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }

            .main-content {
                margin-left: 80px;
            }

            .sidebar-header h6,
            .sidebar-header .org-name,
            .menu-link span {
                display: none;
            }

            .menu-link {
                justify-content: center;
                padding: 12px;
            }

            .menu-link i {
                margin: 0;
            }

            .top-header {
                padding: 15px;
            }

            .user-info span {
                display: none;
            }
        }

        /* Loading Animation */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="/logo.png" alt="Logo">
            <h6>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h6>
            <div class="org-name">‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</div>
        </div>

        <div class="sidebar-menu">
            <div class="menu-item">
                <a href="#dashboard" class="menu-link active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                </a>
            </div>
            <div class="menu-item">
                <a href="#reports" class="menu-link" data-section="reports">
                    <i class="fas fa-file-excel"></i>
                    <span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</span>
                </a>
            </div>
            <div class="menu-item">
                <a href="#employees" class="menu-link" data-section="employees">
                    <i class="fas fa-users"></i>
                    <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
                </a>
            </div>
            <div class="menu-item">
                <a href="/night-shift.html" class="menu-link" target="_blank">
                    <i class="fas fa-moon"></i>
                    <span>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô</span>
                </a>
            </div>
            <div class="menu-item">
                <a href="#settings" class="menu-link" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                </a>
            </div>
            <div class="menu-item">
                <a href="#" class="menu-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <div class="top-header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h4 class="page-title" id="pageTitle">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</h4>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <small id="currentTime" style="margin-right: 15px; color: #6c757d;"></small>
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="container-fluid p-4">
            <!-- Dashboard Section -->
            <div id="settingsSection" class="content-section" style="display: none;">
                <!-- üÜï System Update Section -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-cloud-download-alt"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö (System Update)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <i class="fas fa-code-branch fa-3x text-info"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h6>
                                                <span id="currentVersionDisplay"
                                                    class="badge bg-secondary fs-5">v1.0.0</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div id="updateStatusContainer">
                                            <span class="text-muted"><i class="fas fa-info-circle"></i>
                                                ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-outline-info me-2" onclick="checkForUpdate()">
                                            <i class="fas fa-search"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                                        </button>
                                        <button id="updateBtn" class="btn btn-success" onclick="performUpdate()"
                                            disabled>
                                            <i class="fas fa-download"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö
                                        </button>
                                    </div>
                                </div>
                                <div id="changelogContainer" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-list"></i> ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡∏°‡πà:</h6>
                                        <pre id="changelogText" class="mb-0" style="white-space: pre-wrap;"></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dashboardSection" class="content-section">
                <!-- üÜï Action Buttons Row -->
                <div class="d-flex justify-content-end mb-3">
                    <button class="btn btn-outline-warning btn-sm me-2" onclick="repairOnWorkStatus()">
                        <i class="fas fa-hammer"></i> ‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                    </button>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="forceReloadFromSheets()">
                        <i class="fas fa-sync-alt"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Sheets
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="loadStats()">
                        <i class="fas fa-redo"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                    </button>
                </div>
                <!-- Stats Cards -->
                <div class="row">
                    <div class="col-md-3 mb-4">
                        <div class="stats-card">
                            <div class="stats-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stats-number" id="totalEmployees">0</div>
                            <div class="stats-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4">
                        <div class="stats-card" onclick="showDetailModal('present')" style="cursor: pointer;"
                            title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠">
                            <div class="stats-icon" style="background: linear-gradient(135deg, #28a745, #20c997);">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stats-number" id="presentToday">0</div>
                            <div class="stats-label">‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ <i class="fas fa-external-link-alt"
                                    style="font-size: 0.7rem; opacity: 0.7;"></i></div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4">
                        <div class="stats-card" onclick="showDetailModal('working')" style="cursor: pointer;"
                            title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠">
                            <div class="stats-icon" style="background: linear-gradient(135deg, #ffc107, #fd7e14);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stats-number" id="workingNow">0</div>
                            <div class="stats-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô <i class="fas fa-external-link-alt"
                                    style="font-size: 0.7rem; opacity: 0.7;"></i></div>
                        </div>
                    </div>

                    <div class="col-md-3 mb-4">
                        <div class="stats-card" onclick="showDetailModal('absent')" style="cursor: pointer;"
                            title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠">
                            <div class="stats-icon" style="background: linear-gradient(135deg, #dc3545, #e74c3c);">
                                <i class="fas fa-user-times"></i>
                            </div>
                            <div class="stats-number" id="absentToday">0</div>
                            <div class="stats-label">‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ <i class="fas fa-external-link-alt"
                                    style="font-size: 0.7rem; opacity: 0.7;"></i></div>
                        </div>
                    </div>
                </div> <!-- Currently Working Employees -->
                <div class="working-panel">
                    <h5 class="export-title">
                        <i class="fas fa-users-cog"></i>
                        ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                    </h5>

                    <!-- Employee Filter Controls -->
                    <div class="employee-controls mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="employeeSearch"
                                        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô..." onkeyup="filterEmployees()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="itemsPerPage" onchange="changeItemsPerPage()">
                                    <option value="10">‡πÅ‡∏™‡∏î‡∏á 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                                    <option value="30" selected>‡πÅ‡∏™‡∏î‡∏á 30 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                                    <option value="50">‡πÅ‡∏™‡∏î‡∏á 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                                    <option value="100">‡πÅ‡∏™‡∏î‡∏á 100 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</option>
                                    <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sortBy" onchange="sortEmployees()">
                                    <option value="name">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠</option>
                                    <option value="clockin">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option>
                                    <option value="workinghours">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <div class="employee-count">
                                    <small class="text-muted">
                                        <span id="displayedCount">0</span> / <span id="totalCount">0</span> ‡∏Ñ‡∏ô
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employee List -->
                    <div id="workingEmployeesList">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="employeePagination" class="d-flex justify-content-center mt-3">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="content-section" style="display: none;">
                <div class="export-panel">
                    <h5 class="export-title">
                        <i class="fas fa-file-excel"></i>
                        ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Excel
                    </h5>

                    <!-- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô -->
                    <div class="export-form">
                        <h6 class="mb-3">
                            <i class="fas fa-calendar-day"></i>
                            ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input type="date" class="form-control" id="dailyDate" value="">
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="form-group">
                                    <button class="btn-export" onclick="exportDaily()">
                                        <i class="fas fa-download"></i>
                                        ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô -->
                    <div class="export-form">
                        <h6 class="mb-3">
                            <i class="fas fa-calendar-alt"></i>
                            ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                        </h6>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                                    <select class="form-select" id="monthSelect">
                                        <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                        <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                        <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                        <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                        <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                        <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                        <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                        <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                        <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                        <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                        <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                        <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">‡∏õ‡∏µ ‡∏û.‡∏®.</label>
                                    <select class="form-select" id="yearSelect">
                                        <!-- ‡∏õ‡∏µ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                                    <select class="form-select" id="reportFormat">
                                        <option value="dailySummary">üÜï ‡πÅ‡∏¢‡∏Å‡∏ß‡∏±‡∏ô + ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≤‡∏¢/‡∏Ç‡∏≤‡∏î (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
                                        <option value="detailed">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)</option>
                                        <option value="summary">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <button class="btn-export" onclick="exportMonthly()">
                                        <i class="fas fa-download"></i>
                                        ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
                    <div class="export-form">
                        <h6 class="mb-3">
                            <i class="fas fa-calendar-week"></i>
                            ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                    <input type="date" class="form-control" id="startDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                                    <input type="date" class="form-control" id="endDate">
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <div class="form-group">
                                    <button class="btn-export" onclick="exportRange()">
                                        <i class="fas fa-download"></i>
                                        ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employees Section -->
            <div id="employeesSection" class="content-section" style="display: none;">
                <!-- Manual Clock In/Out -->
                <div class="working-panel mb-4">
                    <h5 class="export-title">
                        <i class="fas fa-clock"></i>
                        ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
                    </h5>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)</label>
                            <select class="form-select" id="manualEmployee" multiple size="8">
                                <option value="" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>
                            </select>
                            <small class="text-muted">‡∏Å‡∏î Ctrl/Cmd ‡∏´‡∏£‡∏∑‡∏≠ Shift ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" class="form-control" id="manualDate">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <input type="time" class="form-control" id="manualTime">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <input type="text" class="form-control" id="manualNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                        </div>
                        <div class="col-md-2 d-flex align-items-end gap-2">
                            <button class="btn btn-success" onclick="manualClockIn()">
                                <i class="fas fa-sign-in-alt"></i> ‡πÄ‡∏Ç‡πâ‡∏≤
                            </button>
                            <button class="btn btn-danger" onclick="manualClockOut()">
                                <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å
                            </button>
                        </div>
                    </div>
                </div>

                <!-- üÜï ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á -->
                <div class="working-panel mb-4">
                    <h5 class="export-title">
                        <i class="fas fa-history"></i>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                    </h5>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <select class="form-select" id="historyEmployee">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" class="form-control" id="historyDate">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="searchHistoricalRecords()">
                                <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                            </button>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-warning w-100" onclick="removeDuplicateRecords()">
                                <i class="fas fa-broom"></i> ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏Ñ‡∏ô/‡∏ß‡∏±‡∏ô)
                            </button>
                        </div>
                    </div>
                    <div id="historicalRecordsResult" class="mt-3" style="display: none;">
                        <!-- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                    </div>
                </div>

                <!-- Employee List -->
                <div class="working-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="export-title mb-0">
                            <i class="fas fa-users"></i>
                            ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                        </h5>
                        <button class="btn btn-primary" onclick="showAddEmployeeModal()">
                            <i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                        </button>
                    </div>

                    <div class="mb-3">
                        <input type="text" class="form-control" id="employeeSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô..."
                            onkeyup="filterEmployeeList()">
                    </div>

                    <div id="employeeListContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settingsSection" class="content-section" style="display: none;">
                <div class="working-panel">
                    <h5 class="export-title">
                        <i class="fas fa-cog"></i>
                        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                    </h5>
                    <p class="text-muted">‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Detail Modal -->
    <div class="modal fade" id="statsDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="fas fa-users"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                        <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <span class="text-muted me-auto" id="modalCount"></span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Time Modal -->
    <div class="modal fade" id="editTimeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-clock" style="color: #667eea;"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editRecordId">
                    <div class="mb-3">
                        <label class="form-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                        <input type="text" class="form-control" id="editEmployeeName" readonly>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤</label>
                            <input type="date" class="form-control" id="editClockInDate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</label>
                            <input type="time" class="form-control" id="editClockInTime">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</label>
                            <input type="date" class="form-control" id="editClockOutDate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</label>
                            <input type="time" class="form-control" id="editClockOutTime">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <input type="text" class="form-control" id="editNote" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" onclick="saveTimeEdit()">
                        <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        const API_BASE_URL = window.location.origin;
        let currentUser = null;
        let tokenRefreshTimeout = null;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            const user = localStorage.getItem('adminUser');

            if (!token || !user) {
                window.location.href = '/admin/login';
                return false;
            }

            try {
                currentUser = JSON.parse(user);
                document.getElementById('userName').textContent = currentUser.name || '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
                document.getElementById('userAvatar').textContent = (currentUser.name || 'A').charAt(0).toUpperCase();

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ auto token refresh
                setupTokenRefresh();

                return true;
            } catch (error) {
                console.error('Error parsing user data:', error);
                logout();
                return false;
            }
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ token ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        function setupTokenRefresh() {
            // ‡∏•‡πâ‡∏≤‡∏á timeout ‡πÄ‡∏î‡∏¥‡∏°
            if (tokenRefreshTimeout) {
                clearTimeout(tokenRefreshTimeout);
            }

            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ refresh token ‡∏ó‡∏∏‡∏Å 20 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ 4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
            tokenRefreshTimeout = setTimeout(async () => {
                await refreshToken();
            }, 20 * 60 * 60 * 1000); // 20 hours
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ token
        async function refreshToken() {
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    throw new Error('No token available');
                }

                console.log('üîÑ Attempting to refresh token...');

                const response = await fetch(`${API_BASE_URL}/api/admin/refresh-token`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å token ‡πÉ‡∏´‡∏°‡πà
                    localStorage.setItem('adminToken', result.token);
                    localStorage.setItem('adminUser', JSON.stringify(result.user));

                    console.log('‚úÖ Token refreshed successfully');

                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ auto refresh ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                    setupTokenRefresh();

                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
                    showQuietNotification('üîÑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß');

                } else {
                    throw new Error(result.error || 'Failed to refresh token');
                }

            } catch (error) {
                console.error('Token refresh failed:', error);

                // ‡∏´‡∏≤‡∏Å token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏∑‡πà‡∏ô
                if (error.message.includes('expired too long') || error.message.includes('invalid')) {
                    Swal.fire({
                        title: '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
                        text: '‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà',
                        icon: 'warning',
                        confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà',
                        allowOutsideClick: false
                    }).then(() => {
                        logout();
                    });
                } else {
                    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° refresh ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á 5 ‡∏ô‡∏≤‡∏ó‡∏µ
                    setTimeout(() => refreshToken(), 5 * 60 * 1000);
                }
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
        function showQuietNotification(message) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á toast notification ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 0.9rem;
                z-index: 9999;
                opacity: 0;
                transition: opacity 0.3s ease;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // ‡πÅ‡∏™‡∏î‡∏á toast
            setTimeout(() => toast.style.opacity = '1', 100);

            // ‡∏ã‡πà‡∏≠‡∏ô toast ‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô API call ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
        async function makeApiCall(url, options = {}) {
            const token = localStorage.getItem('adminToken');

            // üÜï ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: merge headers ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ merge options ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö headers ‡πÉ‡∏´‡∏°‡πà
            const mergedHeaders = {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                ...options.headers
            };

            const finalOptions = {
                ...options,
                headers: mergedHeaders
            };

            try {
                const response = await fetch(url, finalOptions);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
                if (response.status === 401) {
                    const errorData = await response.json().catch(() => ({}));

                    if (errorData.errorCode === 'TOKEN_EXPIRED') {
                        console.log('üîÑ Token expired, attempting refresh...');

                        const refreshSuccess = await refreshToken();
                        if (refreshSuccess) {
                            // ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ token ‡πÉ‡∏´‡∏°‡πà
                            const newToken = localStorage.getItem('adminToken');
                            defaultOptions.headers.Authorization = `Bearer ${newToken}`;
                            return await fetch(url, defaultOptions);
                        }
                    }

                    // ‡∏´‡∏≤‡∏Å refresh ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ login
                    Swal.fire({
                        title: '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
                        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà',
                        icon: 'warning',
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    }).then(() => {
                        logout();
                    });

                    throw new Error('Authentication failed');
                }

                return response;

            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
        }

        // üÜï Force Reload from Sheets
        async function forceReloadFromSheets() {
            const result = await Swal.fire({
                title: '‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Sheets?',
                text: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Google Sheets ‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡πÇ‡∏´‡∏•‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    const response = await makeApiCall(`${API_BASE_URL}/api/admin/force-reload-from-sheets`, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.success) {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', data.message, 'success');
                        loadStats();
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error, 'error');
                    }
                } catch (error) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
                }
            }
        }

        // ========== üÜï Auto-Update Functions ==========

        // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        async function loadCurrentVersion() {
            try {
                const response = await fetch('/api/admin/version');
                const result = await response.json();
                if (result.success) {
                    document.getElementById('currentVersionDisplay').textContent = 'v' + result.version;
                }
            } catch (error) {
                console.error('Error loading version:', error);
            }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        async function checkForUpdate() {
            const statusContainer = document.getElementById('updateStatusContainer');
            const updateBtn = document.getElementById('updateBtn');
            const changelogContainer = document.getElementById('changelogContainer');

            statusContainer.innerHTML = '<span class="text-primary"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>';

            try {
                const response = await makeApiCall('/api/admin/check-update');
                const result = await response.json();

                if (result.success) {
                    document.getElementById('currentVersionDisplay').textContent = 'v' + result.currentVersion;

                    if (result.hasUpdate) {
                        statusContainer.innerHTML = `
                            <span class="text-success">
                                <i class="fas fa-arrow-up"></i> 
                                ‡∏°‡∏µ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà! <strong>v${result.latestVersion}</strong>
                            </span>
                        `;
                        updateBtn.disabled = false;
                        updateBtn.classList.add('btn-pulse');

                        if (result.changelog) {
                            changelogContainer.style.display = 'block';
                            document.getElementById('changelogText').textContent = result.changelog;
                        }
                    } else {
                        statusContainer.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß</span>';
                        updateBtn.disabled = true;
                        changelogContainer.style.display = 'none';
                    }
                } else {
                    statusContainer.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> ' + result.error + '</span>';
                }
            } catch (error) {
                statusContainer.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ</span>';
                console.error('Check update error:', error);
            }
        }

        // ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        async function performUpdate() {
            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï?',
                html: `
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å GitHub ‡πÅ‡∏•‡∏∞ Restart Server</p>
                    <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß 5-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-download"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (!result.isConfirmed) return;

            const statusContainer = document.getElementById('updateStatusContainer');
            const updateBtn = document.getElementById('updateBtn');

            statusContainer.innerHTML = '<span class="text-primary"><i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï... ‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</span>';
            updateBtn.disabled = true;

            try {
                const response = await makeApiCall('/api/admin/update', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    await Swal.fire({
                        title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        html: `
                            <p>${data.message}</p>
                            <p class="text-info">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ Restart ‡πÉ‡∏ô ${data.restartIn} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...</p>
                            <p>‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        `,
                        icon: 'success',
                        timer: 5000,
                        showConfirmButton: false
                    });

                    // ‡∏£‡∏≠ server restart ‡πÅ‡∏•‡πâ‡∏ß reload
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                } else {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', data.error, 'error');
                    statusContainer.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> ' + data.error + '</span>';
                }
            } catch (error) {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ: ' + error.message, 'error');
                statusContainer.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</span>';
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Settings
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentVersion();
        });

        // Navigation
        async function loadSettings() {
            try {
                const container = document.getElementById('settingsContainer');
                container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p>Loading...</p></div>';

                const response = await makeApiCall('/api/admin/settings');
                const result = await response.json();

                if (result.success) {
                    let html = '';
                    const groups = {
                        'GOOGLE': [],
                        'LINE': [],
                        'APP': [],
                        'OTHER': []
                    };

                    // Group keys
                    Object.entries(result.settings).forEach(([key, value]) => {
                        // Skip sensitive keys if needed, or mask them
                        if (key.startsWith('GOOGLE_') || key.includes('SHEET')) groups['GOOGLE'].push({ key, value });
                        else if (key.startsWith('LINE_') || key.startsWith('LIF')) groups['LINE'].push({ key, value });
                        else if (key.startsWith('ADMIN_') || key === 'PORT' || key === 'TIMEZONE' || key.includes('RENDER')) groups['APP'].push({ key, value });
                        else groups['OTHER'].push({ key, value });
                    });

                    // Render groups
                    for (const [groupName, items] of Object.entries(groups)) {
                        if (items.length === 0) continue;

                        let headerIcon = 'cogs';
                        let headerTitle = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                        if (groupName === 'GOOGLE') { headerIcon = 'file-excel'; headerTitle = 'Google Sheets Config'; }
                        if (groupName === 'LINE') { headerIcon = 'comments'; headerTitle = 'LINE Official Config'; }
                        if (groupName === 'APP') { headerIcon = 'server'; headerTitle = 'Application Config'; }

                        html += `
                        <div class="card mb-3 border-0 shadow-sm">
                            <div class="card-header bg-light fw-bold">
                                <i class="fas fa-${headerIcon}"></i> ${headerTitle}
                            </div>
                            <div class="card-body">
                                ${items.map(item => `
                                    <div class="mb-3 row">
                                        <label class="col-sm-4 col-form-label text-end text-muted small user-select-all">${item.key}</label>
                                        <div class="col-sm-8">
                                            <input type="text" class="form-control font-monospace form-control-sm" 
                                                name="${item.key}" value="${item.value}" 
                                                ${item.key.includes('PRIVATE_KEY') ? 'type="password"' : ''}>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    }

                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<div class="alert alert-danger">${result.error || 'Failed to load settings'}</div>`;
                }
            } catch (error) {
                console.error(error);
                document.getElementById('settingsContainer').innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        async function saveSettings() {
            try {
                const form = document.getElementById('settingsForm');
                const inputs = form.querySelectorAll('input');
                const newSettings = {};

                inputs.forEach(input => {
                    newSettings[input.name] = input.value;
                });

                const confirm = await Swal.fire({
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤?',
                    text: "‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Restart Server",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                });

                if (confirm.isConfirmed) {
                    Swal.showLoading();
                    const response = await makeApiCall('/api/admin/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newSettings)
                    });
                    const result = await response.json();

                    if (result.success) {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', result.message, 'success');
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.error, 'error');
                    }
                }
            } catch (error) {
                Swal.fire('Error', error.message, 'error');
            }
        }

        function showSection(sectionId) {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å section
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // ‡πÅ‡∏™‡∏î‡∏á section ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            document.getElementById(sectionId + 'Section').style.display = 'block';

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó active menu
            document.querySelectorAll('.menu-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó page title
            const titles = {
                dashboard: '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å',
                reports: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å',
                employees: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                settings: '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId];

            // üÜï Load Settings if section is settings
            if (sectionId === 'settings' && typeof loadSettings === 'function') {
                loadSettings();
            }

            if (sectionId === 'dashboard') {
                loadStats();
            }
        }

        // Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π
        document.querySelectorAll('.menu-link[data-section]').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const section = this.getAttribute('data-section');
                showSection(section);

                // üÜï ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                if (section === 'employees') {
                    loadEmployees();
                }
            });
        });

        // üÜï ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î stats
        async function showDetailModal(type) {
            const modal = new bootstrap.Modal(document.getElementById('statsDetailModal'));
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalCount = document.getElementById('modalCount');

            const titles = {
                'present': { icon: 'fa-user-check', title: '‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', color: '#28a745' },
                'late': { icon: 'fa-clock', title: '‡∏°‡∏≤‡∏™‡∏≤‡∏¢', color: '#ffc107' },
                'absent': { icon: 'fa-user-times', title: '‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', color: '#dc3545' },
                'working': { icon: 'fa-briefcase', title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', color: '#fd7e14' }
            };

            const config = titles[type] || { icon: 'fa-users', title: '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠', color: '#667eea' };
            modalTitle.innerHTML = `<i class="fas ${config.icon}" style="color: ${config.color}"></i> ${config.title}`;
            modalTitle.setAttribute('data-type', type); // üÜï ‡πÄ‡∏Å‡πá‡∏ö type ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö
            modalBody.innerHTML = `<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>`;
            modalCount.textContent = '';

            modal.show();

            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/stats/${type}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-hover">';
                    html += '<thead><tr><th>#</th><th>‡∏ä‡∏∑‡πà‡∏≠</th>';

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° columns ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                    if (type === 'present') html += '<th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>';
                    else if (type === 'late') html += '<th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡∏°‡∏≤‡∏™‡∏≤‡∏¢</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>';
                    else if (type === 'working') html += '<th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>';

                    html += '</tr></thead><tbody>';

                    result.data.forEach((emp, index) => {
                        html += `<tr><td>${index + 1}</td><td><strong>${emp.name}</strong></td>`;

                        if (type === 'present') {
                            const statusBadge = emp.status === '‡∏™‡∏≤‡∏¢'
                                ? '<span class="badge bg-warning">‡∏™‡∏≤‡∏¢</span>'
                                : '<span class="badge bg-success">‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>';
                            html += `<td>${emp.clockIn}</td><td>${statusBadge}</td>`;
                            html += `<td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="showEditTimeModal('${emp.name.replace(/'/g, "\\'")}', '${emp.clockIn}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTimeRecord('${emp.name.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                            </td>`;
                        } else if (type === 'late') {
                            html += `<td>${emp.clockIn}</td><td><span class="badge bg-warning">${emp.lateBy}</span></td>`;
                            html += `<td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="showEditTimeModal('${emp.name.replace(/'/g, "\\'")}', '${emp.clockIn}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTimeRecord('${emp.name.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                            </td>`;
                        } else if (type === 'working') {
                            html += `<td>${emp.clockIn}</td><td><span class="badge bg-info">${emp.workingHours}</span></td>`;
                            html += `<td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="showEditTimeModal('${emp.name.replace(/'/g, "\\'")}', '${emp.clockIn}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTimeRecord('${emp.name.replace(/'/g, "\\'")}')"><i class="fas fa-trash"></i></button>
                            </td>`;
                        }

                        html += '</tr>';
                    });

                    html += '</tbody></table></div>';
                    modalBody.innerHTML = html;
                    modalCount.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${result.count} ‡∏Ñ‡∏ô`;
                } else {
                    modalBody.innerHTML = `<div class="text-center py-4 text-muted"><i class="fas fa-inbox fa-3x mb-3"></i><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>`;
                    modalCount.textContent = '0 ‡∏Ñ‡∏ô';
                }
            } catch (error) {
                console.error('Error loading detail:', error);
                modalBody.innerHTML = `<div class="text-center py-4 text-danger"><i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>`;
            }
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        async function loadStats() {
            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/stats`);

                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }

                const result = await response.json();

                if (result.success) {
                    const stats = result.data;
                    document.getElementById('totalEmployees').textContent = stats.totalEmployees || 0;
                    document.getElementById('presentToday').textContent = stats.presentToday || 0;
                    document.getElementById('workingNow').textContent = stats.workingNow || 0;
                    document.getElementById('absentToday').textContent = stats.absentToday || 0;

                    // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å server
                    console.log('üìä Stats data from server:', stats);
                    if (stats.workingEmployees) {
                        console.log('üë• Working employees raw data:', stats.workingEmployees);
                    }

                    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                    loadWorkingEmployees(stats.workingEmployees || []);
                }

            } catch (error) {
                console.error('Error loading stats:', error);

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£
                if (error.message === 'Authentication failed') {
                    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢ makeApiCall ‡πÅ‡∏•‡πâ‡∏ß
                    return;
                }

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                showQuietNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà...');

                // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setTimeout(loadStats, 10000);
            }
        }

        // ========== üÜï Employee Management Functions ==========

        let allEmployees = [];

        async function loadEmployees() {
            const container = document.getElementById('employeeListContainer');
            const select = document.getElementById('manualEmployee');

            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/employees`);
                const result = await response.json();

                if (result.success) {
                    allEmployees = result.data;
                    renderEmployeeList(allEmployees);

                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö manual clock
                    select.innerHTML = '<option value="" disabled>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô --</option>';
                    allEmployees.forEach(emp => {
                        const opt = document.createElement('option');
                        opt.value = emp.name;
                        opt.textContent = emp.name + (emp.isWorking ? ' üü¢' : '');
                        select.appendChild(opt);
                    });

                    // üÜï ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                    const historySelect = document.getElementById('historyEmployee');
                    if (historySelect) {
                        historySelect.innerHTML = '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô --</option>';
                        allEmployees.forEach(emp => {
                            const opt = document.createElement('option');
                            opt.value = emp.name;
                            opt.textContent = emp.name;
                            historySelect.appendChild(opt);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading employees:', error);
                container.innerHTML = '<div class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle"></i> ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
            }
        }

        function renderEmployeeList(employees) {
            const container = document.getElementById('employeeListContainer');

            if (employees.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-inbox fa-3x mb-3"></i><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</p></div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>#</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';

            employees.forEach((emp, index) => {
                const statusBadge = emp.isWorking
                    ? '<span class="badge bg-success">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>'
                    : '<span class="badge bg-secondary">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>';

                html += `<tr>
                    <td>${index + 1}</td>
                    <td><strong>${emp.name}</strong></td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee('${emp.name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function filterEmployeeList() {
            const search = document.getElementById('employeeSearchInput').value.toLowerCase();
            const filtered = allEmployees.filter(emp => emp.name.toLowerCase().includes(search));
            renderEmployeeList(filtered);
        }

        async function showAddEmployeeModal() {
            const { value: name } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
                input: 'text',
                inputLabel: '‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                inputPlaceholder: '‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                showCancelButton: true,
                confirmButtonText: '‡πÄ‡∏û‡∏¥‡πà‡∏°',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                inputValidator: (value) => {
                    if (!value || !value.trim()) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
                }
            });

            if (name) {
                try {
                    const response = await makeApiCall(`${API_BASE_URL}/api/admin/employees`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name.trim() })
                    });
                    const result = await response.json();

                    if (result.success) {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', result.message, 'success');
                        loadEmployees();
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.error, 'error');
                    }
                } catch (error) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
                }
            }
        }

        async function deleteEmployee(name) {
            const confirm = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (confirm.isConfirmed) {
                try {
                    const response = await makeApiCall(`${API_BASE_URL}/api/admin/employees/${encodeURIComponent(name)}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();

                    if (result.success) {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', result.message, 'success');
                        loadEmployees();
                        loadStats();
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.error, 'error');
                    }
                } catch (error) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
                }
            }
        }

        // ========== üÜï Manual Clock Functions ==========

        function getSelectedManualEmployees() {
            const select = document.getElementById('manualEmployee');
            return Array.from(select.selectedOptions)
                .map(opt => opt.value)
                .filter(Boolean);
        }

        async function manualClockIn() {
            const employees = getSelectedManualEmployees();
            const date = document.getElementById('manualDate').value;
            const time = document.getElementById('manualTime').value;
            const note = document.getElementById('manualNote').value;

            if (!employees.length || !date || !time) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤', 'error');
                return;
            }

            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/manual-clockin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employees, date, time, note })
                });
                const result = await response.json();

                if (result.success) {
                    const errors = result.errors?.length ? `\n‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.errors.join('\n')}` : '';
                    Swal.fire(result.partial ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' : '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', (result.message || '') + errors, result.partial ? 'info' : 'success');
                    loadStats();
                    loadEmployees();
                    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
                    document.getElementById('manualNote').value = '';
                } else {
                    const errorText = result.error || (result.errors && result.errors.join('\n')) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ';
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', errorText, 'error');
                }
            } catch (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            }
        }

        async function manualClockOut() {
            const employees = getSelectedManualEmployees();
            const date = document.getElementById('manualDate').value;
            const time = document.getElementById('manualTime').value;
            const note = document.getElementById('manualNote').value;

            if (!employees.length || !date || !time) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤', 'error');
                return;
            }

            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/manual-clockout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employees, date, time, note })
                });
                const result = await response.json();

                if (result.success) {
                    const errors = result.errors?.length ? `\n‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.errors.join('\n')}` : '';
                    Swal.fire(result.partial ? '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' : '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', (result.message || '') + errors, result.partial ? 'info' : 'success');
                    loadStats();
                    loadEmployees();
                    document.getElementById('manualNote').value = '';
                } else {
                    const errorText = result.error || (result.errors && result.errors.join('\n')) || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ';
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', errorText, 'error');
                }
            } catch (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            }
        }

        // üÜï ========== Edit Time Functions ==========

        let currentEditRecordId = null;

        async function showEditTimeModal(employeeName, clockInTime) {
            const modal = new bootstrap.Modal(document.getElementById('editTimeModal'));

            document.getElementById('editEmployeeName').value = employeeName;
            document.getElementById('editNote').value = '';

            // üÜï ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö format ‡πÉ‡∏ô database
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const todayDDMMYYYY = `${day}/${month}/${year}`;

            // ‡πÉ‡∏ä‡πâ YYYY-MM-DD ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input type="date"
            const todayForInput = now.toISOString().split('T')[0];
            document.getElementById('editClockInDate').value = todayForInput;

            // ‡πÅ‡∏õ‡∏•‡∏á HH:mm:ss ‡πÄ‡∏õ‡πá‡∏ô HH:mm ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö time input
            const timePart = clockInTime.split(':').slice(0, 2).join(':');
            document.getElementById('editClockInTime').value = timePart;

            // clock out ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
            document.getElementById('editClockOutDate').value = todayForInput;
            document.getElementById('editClockOutTime').value = '';

            // ‡∏î‡∏∂‡∏á record id ‡πÇ‡∏î‡∏¢‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏ä‡πâ DD/MM/YYYY)
            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/time-records/${encodeURIComponent(employeeName)}/${encodeURIComponent(todayDDMMYYYY)}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    const record = result.data[0]; // ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                    currentEditRecordId = record.id;

                    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
                    if (record.clock_in) {
                        const [datePart, timePartFull] = record.clock_in.split(' ');
                        if (datePart) {
                            const [d, m, y] = datePart.split('/');
                            document.getElementById('editClockInDate').value = `${y}-${m}-${d}`;
                        }
                        if (timePartFull) {
                            document.getElementById('editClockInTime').value = timePartFull.slice(0, 5);
                        }
                    }

                    if (record.clock_out) {
                        const [datePart, timePartFull] = record.clock_out.split(' ');
                        if (datePart) {
                            const [d, m, y] = datePart.split('/');
                            document.getElementById('editClockOutDate').value = `${y}-${m}-${d}`;
                        }
                        if (timePartFull) {
                            document.getElementById('editClockOutTime').value = timePartFull.slice(0, 5);
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching record:', error);
            }

            modal.show();
        }

        async function saveTimeEdit() {
            const employeeName = document.getElementById('editEmployeeName').value;
            const clockInDate = document.getElementById('editClockInDate').value;
            const clockInTime = document.getElementById('editClockInTime').value;
            const clockOutDate = document.getElementById('editClockOutDate').value;
            const clockOutTime = document.getElementById('editClockOutTime').value;
            const note = document.getElementById('editNote').value;

            if (!currentEditRecordId) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
                return;
            }

            const data = {
                employeeName,
                clockIn: clockInDate && clockInTime ? { date: clockInDate, time: clockInTime } : null,
                clockOut: clockOutDate && clockOutTime ? { date: clockOutDate, time: clockOutTime } : null,
                note
            };

            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/time-records/${currentEditRecordId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editTimeModal')).hide();
                    loadStats();
                    currentEditRecordId = null;
                } else {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.error, 'error');
                }
            } catch (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            }
        }

        // üÜï ========== Historical Records Functions ==========

        async function searchHistoricalRecords() {
            const employee = document.getElementById('historyEmployee').value;
            const date = document.getElementById('historyDate').value;

            if (!date) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'error');
                return;
            }

            // ‡πÅ‡∏õ‡∏•‡∏á YYYY-MM-DD ‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY
            const [y, m, d] = date.split('-');
            const dateDDMMYYYY = `${d}/${m}/${y}`;

            try {
                let url = `${API_BASE_URL}/api/admin/time-records-by-date/${encodeURIComponent(dateDDMMYYYY)}`;
                if (employee) {
                    url += `?employee=${encodeURIComponent(employee)}`;
                }

                const response = await makeApiCall(url);
                const result = await response.json();

                const container = document.getElementById('historicalRecordsResult');
                container.style.display = 'block';

                if (result.success && result.data.length > 0) {
                    let html = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="alert alert-info mb-0 flex-grow-1 me-3">
                                <strong>‡∏û‡∏ö ${result.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d}/${m}/${y}
                            </div>
                            <div>
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="selectAllHistoricalRecords()">
                                    <i class="fas fa-check-square"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteSelectedRecords()">
                                    <i class="fas fa-trash"></i> ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (<span id="selectedCount">0</span>)
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="historicalRecordsTable">
                                <thead>
                                    <tr>
                                        <th style="width:40px;">
                                            <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                                        </th>
                                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                                        <th>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</th>
                                        <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</th>
                                        <th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                                        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                        <th>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    result.data.forEach(record => {
                        const clockInTime = record.clock_in ? record.clock_in.split(' ')[1] || record.clock_in : '-';
                        const clockOutTime = record.clock_out ? record.clock_out.split(' ')[1] || record.clock_out : '-';
                        // Escape single quotes for JS
                        const safeNote = (record.note || '').replace(/'/g, "\\'");
                        const safeClockIn = (record.clock_in || '').replace(/'/g, "\\'");
                        const safeClockOut = (record.clock_out || '').replace(/'/g, "\\'");
                        html += `
                            <tr data-record-id="${record.id}">
                                <td>
                                    <input type="checkbox" class="record-checkbox" value="${record.id}" 
                                           data-employee="${record.employee_name}" onchange="updateSelectedCount()">
                                </td>
                                <td><strong>${record.employee_name}</strong></td>
                                <td>${clockInTime}</td>
                                <td>${clockOutTime}</td>
                                <td>${record.working_hours ? parseFloat(record.working_hours).toFixed(1) + ' ‡∏ä‡∏°.' : '-'}</td>
                                <td>${record.note || '-'}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="editHistoricalRecord(${record.id}, '${record.employee_name}', '${safeClockIn}', '${safeClockOut}', '${safeNote}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteHistoricalRecord(${record.id}, '${record.employee_name}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d}/${m}/${y}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Search error:', error);
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            }
        }

        function editHistoricalRecord(recordId, employeeName, clockIn, clockOut, note) {
            currentEditRecordId = recordId;
            document.getElementById('editEmployeeName').value = employeeName;
            document.getElementById('editNote').value = note;

            // Parse clock_in
            if (clockIn) {
                const [datePart, timePart] = clockIn.split(' ');
                if (datePart) {
                    const [d, m, y] = datePart.split('/');
                    document.getElementById('editClockInDate').value = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                }
                if (timePart) {
                    document.getElementById('editClockInTime').value = timePart.slice(0, 5);
                }
            }

            // Parse clock_out
            if (clockOut) {
                const [datePart, timePart] = clockOut.split(' ');
                if (datePart) {
                    const [d, m, y] = datePart.split('/');
                    document.getElementById('editClockOutDate').value = `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                }
                if (timePart) {
                    document.getElementById('editClockOutTime').value = timePart.slice(0, 5);
                }
            } else {
                document.getElementById('editClockOutDate').value = '';
                document.getElementById('editClockOutTime').value = '';
            }

            new bootstrap.Modal(document.getElementById('editTimeModal')).show();
        }

        async function deleteHistoricalRecord(recordId, employeeName) {
            const confirm = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á "${employeeName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: '‡∏•‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (confirm.isConfirmed) {
                try {
                    const response = await makeApiCall(`${API_BASE_URL}/api/admin/time-records/${recordId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();

                    if (result.success) {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', result.message, 'success');
                        searchHistoricalRecords(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                        loadStats();
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.error, 'error');
                    }
                } catch (error) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
                }
            }
        }

        // üÜï ========== Bulk Selection Functions ==========

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.record-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedCount();
        }

        function selectAllHistoricalRecords() {
            const selectAllCb = document.getElementById('selectAllCheckbox');
            if (selectAllCb) {
                selectAllCb.checked = true;
                toggleSelectAll(selectAllCb);
            }
        }

        function updateSelectedCount() {
            const checked = document.querySelectorAll('.record-checkbox:checked');
            const countSpan = document.getElementById('selectedCount');
            if (countSpan) {
                countSpan.textContent = checked.length;
            }
        }

        function getSelectedRecordIds() {
            const checked = document.querySelectorAll('.record-checkbox:checked');
            return Array.from(checked).map(cb => parseInt(cb.value));
        }

        async function deleteSelectedRecords() {
            const selectedIds = getSelectedRecordIds();

            if (selectedIds.length === 0) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'warning');
                return;
            }

            const confirm = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?',
                html: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö <strong>${selectedIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong> ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br><small class="text-danger">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</small>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: `‡∏•‡∏ö ${selectedIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (confirm.isConfirmed) {
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...',
                    html: `<div class="progress"><div class="progress-bar" id="deleteProgress" style="width: 0%"></div></div>`,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => Swal.showLoading()
                });

                let successCount = 0;
                let errorCount = 0;

                for (let i = 0; i < selectedIds.length; i++) {
                    try {
                        const response = await makeApiCall(`${API_BASE_URL}/api/admin/time-records/${selectedIds[i]}`, {
                            method: 'DELETE'
                        });
                        const result = await response.json();

                        if (result.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                    }

                    // Update progress
                    const progress = Math.round(((i + 1) / selectedIds.length) * 100);
                    const progressBar = document.getElementById('deleteProgress');
                    if (progressBar) progressBar.style.width = `${progress}%`;
                }

                Swal.fire({
                    title: '‡∏•‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                    html: `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong class="text-success">${successCount}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: <strong class="text-danger">${errorCount}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                    icon: errorCount > 0 ? 'warning' : 'success'
                });

                searchHistoricalRecords(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                loadStats();
            }
        }

        // üÜï ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏Ñ‡∏ô/‡∏ß‡∏±‡∏ô - ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î)
        async function removeDuplicateRecords() {
            const date = document.getElementById('historyDate').value;

            if (!date) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥', 'warning');
                return;
            }

            // ‡πÅ‡∏õ‡∏•‡∏á YYYY-MM-DD ‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY
            const [y, m, d] = date.split('-');
            const dateDDMMYYYY = `${d}/${m}/${y}`;

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/time-records-by-date/${encodeURIComponent(dateDDMMYYYY)}`);
                const result = await response.json();

                if (!result.success || result.data.length === 0) {
                    Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d}/${m}/${y}`, 'info');
                    return;
                }

                // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                const groupedByEmployee = {};
                result.data.forEach(record => {
                    const name = record.employee_name;
                    if (!groupedByEmployee[name]) {
                        groupedByEmployee[name] = [];
                    }
                    groupedByEmployee[name].push(record);
                });

                // ‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö (‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å - ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î)
                const recordsToDelete = [];
                const duplicateInfo = [];

                Object.entries(groupedByEmployee).forEach(([name, records]) => {
                    if (records.length > 1) {
                        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤)
                        records.sort((a, b) => {
                            const timeA = a.clock_in ? a.clock_in.split(' ')[1] || '99:99:99' : '99:99:99';
                            const timeB = b.clock_in ? b.clock_in.split(' ')[1] || '99:99:99' : '99:99:99';
                            return timeA.localeCompare(timeB);
                        });

                        // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡πÑ‡∏ß‡πâ ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                        for (let i = 1; i < records.length; i++) {
                            recordsToDelete.push(records[i].id);
                        }
                        duplicateInfo.push(`${name} (${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Üí ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1)`);
                    }
                });

                Swal.close();

                if (recordsToDelete.length === 0) {
                    Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥', `‡∏ó‡∏∏‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö`, 'success');
                    return;
                }

                // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                const confirm = await Swal.fire({
                    title: '‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥!',
                    html: `
                        <div style="text-align: left; max-height: 300px; overflow-y: auto;">
                            <p><strong>‡∏à‡∏∞‡∏•‡∏ö ${recordsToDelete.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥</strong> ‡πÇ‡∏î‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô:</p>
                            <ul>
                                ${duplicateInfo.map(info => `<li>${info}</li>`).join('')}
                            </ul>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    confirmButtonText: `‡∏•‡∏ö ${recordsToDelete.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥`,
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                });

                if (confirm.isConfirmed) {
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥...',
                        html: `<div class="progress"><div class="progress-bar bg-warning" id="dupDeleteProgress" style="width: 0%"></div></div>`,
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => Swal.showLoading()
                    });

                    let successCount = 0;
                    let errorCount = 0;

                    for (let i = 0; i < recordsToDelete.length; i++) {
                        try {
                            const delResponse = await makeApiCall(`${API_BASE_URL}/api/admin/time-records/${recordsToDelete[i]}`, {
                                method: 'DELETE'
                            });
                            const delResult = await delResponse.json();
                            if (delResult.success) {
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        } catch (error) {
                            errorCount++;
                        }

                        const progress = Math.round(((i + 1) / recordsToDelete.length) * 100);
                        const progressBar = document.getElementById('dupDeleteProgress');
                        if (progressBar) progressBar.style.width = `${progress}%`;
                    }

                    Swal.fire({
                        title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                        html: `‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <strong class="text-success">${successCount}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: <strong class="text-danger">${errorCount}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                        icon: errorCount > 0 ? 'warning' : 'success'
                    });

                    searchHistoricalRecords();
                    loadStats();
                }
            } catch (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            }
        }

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default date ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('manualDate');
            if (dateInput) dateInput.value = today;

            // üÜï ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ historyDate ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            const historyDateInput = document.getElementById('historyDate');
            if (historyDateInput) historyDateInput.value = today;
        });

        // üÜï ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô historyEmployee dropdown
        async function loadHistoryEmployeeDropdown() {
            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/employees`);
                const result = await response.json();

                if (result.success) {
                    const select = document.getElementById('historyEmployee');
                    // Clear existing options (keep first)
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    // Add employees
                    result.employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.name;
                        option.textContent = emp.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading employees for history:', error);
            }
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        const originalLoadEmployees = typeof loadEmployees === 'function' ? loadEmployees : async () => { };
        async function loadEmployeesWithHistory() {
            await originalLoadEmployees();
            await loadHistoryEmployeeDropdown();
        }

        // üÜï ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤
        async function deleteTimeRecord(employeeName) {
            // üÜï ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö format ‡πÉ‡∏ô database
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const today = `${day}/${month}/${year}`;

            // ‡∏î‡∏∂‡∏á record id
            try {
                const response = await makeApiCall(`${API_BASE_URL}/api/admin/time-records/${encodeURIComponent(employeeName)}/${encodeURIComponent(today)}`);
                const result = await response.json();

                if (!result.success || result.data.length === 0) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                    return;
                }

                const recordId = result.data[0].id;

                // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                const confirm = await Swal.fire({
                    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                    text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á "${employeeName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    confirmButtonText: '‡∏•‡∏ö',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                });

                if (confirm.isConfirmed) {
                    const deleteResponse = await makeApiCall(`${API_BASE_URL}/api/admin/time-records/${recordId}`, {
                        method: 'DELETE'
                    });
                    const deleteResult = await deleteResponse.json();

                    if (deleteResult.success) {
                        await Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', deleteResult.message, 'success');

                        // üÜï ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î stats ‡πÅ‡∏•‡∏∞ Modal content
                        loadStats();

                        // üÜï ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î Modal content ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î
                        const currentModalType = document.getElementById('modalTitle').getAttribute('data-type');
                        if (currentModalType) {
                            showDetailModal(currentModalType);
                        } else {
                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ type ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('statsDetailModal'));
                            if (modal) modal.hide();
                        }
                    } else {
                        Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', deleteResult.error, 'error');
                    }
                }
            } catch (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
        function formatThaiTime(timeString) {
            if (!timeString) return '-';

            try {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö HH:mm ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å server ‡πÅ‡∏•‡πâ‡∏ß
                if (typeof timeString === 'string' && timeString.match(/^\d{2}:\d{2}$/)) {
                    return timeString;
                }

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 'YYYY-MM-DD HH:mm:ss' (‡∏à‡∏≤‡∏Å moment)
                if (typeof timeString === 'string' && timeString.includes(' ') && timeString.length === 19) {
                    const timePart = timeString.split(' ')[1];
                    return timePart.substring(0, 5); // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà HH:mm
                }

                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ' ‡∏ô.' ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                if (timeString.includes(' ‡∏ô.')) {
                    return timeString;
                }

                // ‡∏•‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Date object
                const date = new Date(timeString);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleTimeString('th-TH', {
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'Asia/Bangkok'
                    });
                }

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Date object
                if (timeString instanceof Date) {
                    return timeString.toLocaleTimeString('th-TH', {
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZone: 'Asia/Bangkok'
                    });
                }

                return timeString;
            } catch (error) {
                console.error('Error formatting time:', error);
                return timeString || '-';
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢
        function formatThaiDate(dateString) {
            if (!dateString) return '';

            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;

                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    timeZone: 'Asia/Bangkok'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return dateString;
            }
        }        // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        let allWorkingEmployees = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        let filteredEmployees = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á
        let currentPage = 1;
        let itemsPerPageValue = 30;

        function loadWorkingEmployees(employees) {
            allWorkingEmployees = [...employees];
            filteredEmployees = [...employees];

            updateEmployeeCount();
            displayEmployees();
        }

        function updateEmployeeCount() {
            document.getElementById('totalCount').textContent = allWorkingEmployees.length;
        }

        function displayEmployees() {
            const container = document.getElementById('workingEmployeesList');

            if (filteredEmployees.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-user-clock"></i>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
                    </div>
                `;
                document.getElementById('displayedCount').textContent = '0';
                document.getElementById('employeePagination').innerHTML = '';
                return;
            }

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì pagination
            const startIndex = (currentPage - 1) * itemsPerPageValue;
            const endIndex = itemsPerPageValue === 'all' ? filteredEmployees.length : startIndex + itemsPerPageValue;
            const currentEmployees = filteredEmployees.slice(startIndex, endIndex);

            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            const html = currentEmployees.map(emp => {
                const clockInTime = formatThaiTime(emp.clockIn);

                return `
                    <div class="employee-item">
                        <div class="employee-info">
                            <div class="employee-name">${emp.name}</div>
                            <div class="employee-time">
                                <i class="fas fa-clock"></i>
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô: ${clockInTime} | ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${emp.workingHours}
                            </div>
                        </div>
                        <div class="status-badge">
                            <i class="fas fa-circle"></i>
                            ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
            document.getElementById('displayedCount').textContent = currentEmployees.length;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á pagination
            if (itemsPerPageValue !== 'all') {
                generatePagination();
            } else {
                document.getElementById('employeePagination').innerHTML = '';
            }
        }

        function generatePagination() {
            const totalPages = Math.ceil(filteredEmployees.length / itemsPerPageValue);
            const paginationContainer = document.getElementById('employeePagination');

            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            let html = '<nav><ul class="pagination">';

            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`;
            }

            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            html += '</ul></nav>';
            paginationContainer.innerHTML = html;
        }

        function changePage(page) {
            const totalPages = Math.ceil(filteredEmployees.length / itemsPerPageValue);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            displayEmployees();
        }

        function changeItemsPerPage() {
            const select = document.getElementById('itemsPerPage');
            itemsPerPageValue = select.value === 'all' ? 'all' : parseInt(select.value);
            currentPage = 1;
            displayEmployees();
        }

        function filterEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();

            filteredEmployees = allWorkingEmployees.filter(emp =>
                emp.name.toLowerCase().includes(searchTerm)
            );

            currentPage = 1;
            displayEmployees();
        }

        function sortEmployees() {
            const sortBy = document.getElementById('sortBy').value;

            filteredEmployees.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name, 'th');
                    case 'clockin':
                        return a.clockIn.localeCompare(b.clockIn);
                    case 'workinghours':
                        const aHours = parseFloat(a.workingHours.replace(' ‡∏ä‡∏°.', ''));
                        const bHours = parseFloat(b.workingHours.replace(' ‡∏ä‡∏°.', ''));
                        return bHours - aHours; // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                    default:
                        return 0;
                }
            });

            currentPage = 1;
            displayEmployees();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export
        async function exportDaily() {
            const date = document.getElementById('dailyDate').value;
            if (!date) {
                Swal.fire({
                    title: '‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                    icon: 'warning'
                });
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const selectedDate = new Date(date);
            const today = new Date();
            today.setHours(23, 59, 59, 999); // ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

            if (selectedDate > today) {
                Swal.fire({
                    title: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ',
                    icon: 'warning'
                });
                return;
            }

            await downloadReport('daily', { date });
        }
        async function exportMonthly() {
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;
            const format = document.getElementById('reportFormat').value;

            if (!month || !year) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                    icon: 'warning'
                });
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
            const selectedDate = new Date(parseInt(year), parseInt(month) - 1, 1);
            const today = new Date();
            const currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            if (selectedDate > currentMonth) {
                Swal.fire({
                    title: '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ',
                    icon: 'warning'
                });
                return;
            }

            // ‡∏™‡πà‡∏á format parameter ‡πÑ‡∏õ‡πÉ‡∏ô query string ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ backend ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            await downloadReport('monthly', { month, year, format });
        }

        async function exportRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                    icon: 'warning'
                });
                return;
            }

            if (startDate > endDate) {
                Swal.fire({
                    title: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    text: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î',
                    icon: 'warning'
                });
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 366 ‡∏ß‡∏±‡∏ô (1 ‡∏õ‡∏µ)
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));

            if (diffDays > 366) {
                Swal.fire({
                    title: '‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏õ‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                    icon: 'warning'
                });
                return;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            if (end > today) {
                Swal.fire({
                    title: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ',
                    icon: 'warning'
                });
                return;
            }

            await downloadReport('range', { startDate, endDate });
        }

        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        async function downloadReport(type, params) {
            try {
                // ‡πÅ‡∏™‡∏î‡∏á loading ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                const loadingTitle = getLoadingTitle(type, params);
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...',
                    html: `${loadingTitle}<br><small class="text-muted">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel</small>`,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const token = localStorage.getItem('adminToken');
                if (!token) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Token ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                }

                const queryString = new URLSearchParams(params).toString();

                const response = await makeApiCall(`${API_BASE_URL}/api/admin/export/${type}?${queryString}`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Content-Type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')) {
                    throw new Error('‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏ü‡∏•‡πå Excel ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }

                // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
                const filename = getFilename(type, params);
                a.download = filename;

                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    html: getSuccessMessage(type, params, filename),
                    timer: 4000,
                    showConfirmButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });

            } catch (error) {
                console.error('Export error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                    html: `
                        <div style="text-align: left;">
                            <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong></p>
                            <p class="text-danger">${error.message}</p>
                            <hr>
                            <p><strong>‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong></p>
                            <ul>
                                <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</li>
                                <li>‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà</li>
                                <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á</li>
                                <li>‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤</li>
                            </ul>
                        </div>
                    `,
                    showConfirmButton: true,
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                });
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export
        function getLoadingTitle(type, params) {
            switch (type) {
                case 'daily':
                    return `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: ${formatDateThai(params.date)}`;
                case 'monthly':
                    const monthNames = [
                        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
                    ];
                    return `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${monthNames[params.month - 1]} ${parseInt(params.year) + 543}`;
                case 'range':
                    return `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatDateThai(params.startDate)} - ${formatDateThai(params.endDate)}`;
                default:
                    return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
            }
        }

        function getSuccessMessage(type, params, filename) {
            const details = getReportDetails(type, params);
            return `
                <div style="text-align: left;">
                    <p><strong>‡πÑ‡∏ü‡∏•‡πå:</strong> ${filename}</p>
                    <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${details.title}</p>
                    <p><strong>‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ${details.period}</p>
                    <hr>
                    <p><strong>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</strong></p>
                    <ul>
                        <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</li>
                        <li>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</li>
                        <li>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</li>
                        <li>‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡∏µ‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≤‡∏á‡πÜ</li>
                        <li>‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</li>
                    </ul>
                </div>
            `;
        }

        function getReportDetails(type, params) {
            switch (type) {
                case 'daily':
                    return {
                        title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô',
                        period: formatDateThai(params.date)
                    };
                case 'monthly':
                    const monthNames = [
                        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
                    ];
                    return {
                        title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',
                        period: `${monthNames[params.month - 1]} ${parseInt(params.year) + 543}`
                    };
                case 'range':
                    return {
                        title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà',
                        period: `${formatDateThai(params.startDate)} ‡∏ñ‡∏∂‡∏á ${formatDateThai(params.endDate)}`
                    };
                default:
                    return { title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', period: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' };
            }
        }

        function formatDateThai(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                timeZone: 'Asia/Bangkok'
            });
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
        function getFilename(type, params) {
            const now = new Date();
            const thaiDate = now.toLocaleDateString('th-TH', {
                timeZone: 'Asia/Bangkok',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '');
            const thaiTime = now.toLocaleTimeString('th-TH', {
                timeZone: 'Asia/Bangkok',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/:/g, '');

            const timestamp = `${thaiDate}_${thaiTime}`;

            switch (type) {
                case 'daily':
                    const dailyDate = new Date(params.date).toLocaleDateString('th-TH', {
                        timeZone: 'Asia/Bangkok',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    }).replace(/\//g, '');
                    return `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô_${dailyDate}_${timestamp}.xlsx`;

                case 'monthly':
                    const monthNames = [
                        '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
                        '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'
                    ];
                    const yearBE = parseInt(params.year) + 543;
                    const formatSuffix = params.format === 'detailed' ? '_‡πÅ‡∏ö‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô' : '';
                    return `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô_${monthNames[params.month - 1]}${yearBE}${formatSuffix}_${timestamp}.xlsx`;

                case 'range':
                    const startDate = new Date(params.startDate).toLocaleDateString('th-TH', {
                        timeZone: 'Asia/Bangkok',
                        month: '2-digit',
                        day: '2-digit'
                    }).replace(/\//g, '');
                    const endDate = new Date(params.endDate).toLocaleDateString('th-TH', {
                        timeZone: 'Asia/Bangkok',
                        month: '2-digit',
                        day: '2-digit'
                    }).replace(/\//g, '');
                    return `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà_${startDate}-${endDate}_${timestamp}.xlsx`;

                default:
                    return `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_${timestamp}.xlsx`;
            }
        }

        // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        function logout() {
            Swal.fire({
                title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ‡∏•‡πâ‡∏≤‡∏á token refresh timeout
                    if (tokenRefreshTimeout) {
                        clearTimeout(tokenRefreshTimeout);
                        tokenRefreshTimeout = null;
                    }

                    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminUser');

                    // redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
                    window.location.href = '/admin/login';
                }
            });
        }          // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        function initializePage() {
            // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            const today = new Date();

            // ‡∏ï‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
            const dateString = today.toLocaleDateString('en-CA', { timeZone: 'Asia/Bangkok' }); // YYYY-MM-DD format
            document.getElementById('dailyDate').value = dateString;

            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢  
            const thaiMonth = today.toLocaleDateString('th-TH', {
                month: 'numeric',
                timeZone: 'Asia/Bangkok'
            });
            const thaiYear = today.toLocaleDateString('en-CA', {
                year: 'numeric',
                timeZone: 'Asia/Bangkok'
            });

            document.getElementById('monthSelect').value = parseInt(thaiMonth);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏µ
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = parseInt(thaiYear); // ‡πÉ‡∏ä‡πâ‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡∏à‡∏≤‡∏Å en-CA
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô ‡∏Ñ.‡∏®. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ backend
                option.textContent = (year + 543) + ' (‡∏û.‡∏®.)'; // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô ‡∏û.‡∏®. ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ) ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
            const startOfWeek = new Date(dateString);
            const dayOfWeek = startOfWeek.getDay();
            startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            document.getElementById('startDate').value = startOfWeek.toISOString().split('T')[0];
            document.getElementById('endDate').value = endOfWeek.toISOString().split('T')[0];
        }          // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        function updateCurrentTime() {
            const now = new Date();

            // ‡πÉ‡∏ä‡πâ timezone Bangkok ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏ß‡∏Å 7 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            const timeString = now.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Bangkok'
            });

            const dateString = now.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                timeZone: 'Asia/Bangkok'
            });

            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.innerHTML = `<i class="fas fa-clock"></i> ${dateString} ${timeString}`;
            }
        }

        // ...existing code...

        // üÜï Function ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ On-Work
        async function repairOnWorkStatus() {
            try {
                const result = await Swal.fire({
                    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞?',
                    text: "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà Clock In ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏´‡∏≤‡∏¢‡πÑ‡∏õ) ‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#ffc107',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                });

                if (result.isConfirmed) {
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°...',
                        html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ Sync...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading() }
                    });

                    const response = await makeApiCall('/api/admin/repair-on-work', {
                        method: 'POST'
                    });

                    const data = await response.json();

                    if (data.success) {
                        let message = `‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${data.totalOpen} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>`;
                        if (data.repairedCount > 0) {
                            message += `‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <b>${data.repairedCount}</b> ‡∏Ñ‡∏ô<br>`;
                            message += `<small class="text-muted">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠: ${data.repairedEmployees.join(', ')}</small>`;
                        } else {
                            message += `‚ú® ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏° (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô)`;
                        }

                        Swal.fire({
                            title: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                            html: message,
                            icon: 'success'
                        }).then(() => {
                            loadStats(); // Reload stats/list to show repaired employees
                        });
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                }
            } catch (error) {
                console.error('Repair error:', error);
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        document.addEventListener('DOMContentLoaded', function () {
            if (checkAuth()) {
                initializePage();
                loadStats();
                updateCurrentTime();

                // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setInterval(loadStats, 30000);
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                setInterval(updateCurrentTime, 1000);
            }

            // ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(function (registration) {
                        console.log('üîß Service Worker ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', registration.scope);

                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Service Worker
                        registration.addEventListener('updatefound', function () {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function () {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ ‡∏°‡∏µ Service Worker ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                                }
                            });
                        });
                    })
                    .catch(function (error) {
                        console.error('‚ùå ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
                    });
            }
        });
    </script>
</body>

</html>