<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà">
    <title>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ | ‡∏≠‡∏ö‡∏ï.‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/logo.png">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=K2D&family=Kanit:wght@300;400;500;600;700&family=Sriracha&display=swap"
        rel="stylesheet">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        @font-face {
            font-family: 'Digital dream Fat';
            src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2'),
                url('https://semicon.github.io/fonts/DigitaldreamFat.woff') format('woff');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', sans-serif;
            min-height: 100vh;
            background: url("./background.jpg") no-repeat center center fixed;
            background-size: cover;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
        }

        .card-3d {
            background: rgba(221, 255, 255, 0.9);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.3));
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .clock {
            font-family: 'Digital dream Fat', monospace;
            font-size: 32px;
            color: #00f6fa;
            letter-spacing: 3px;
            text-shadow: 1px 1px 2px teal, 0 0 25px green;
            background: #333;
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            border: 3px solid #555;
        }

        /* Profile Card */
        .profile-card {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .profile-card img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #4CAF50;
            object-fit: cover;
        }

        .profile-card .info h2 {
            font-size: 1.2rem;
            color: #333;
        }

        .profile-card .info p {
            font-size: 0.85rem;
            color: #666;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(180deg, #fff 0%, #f5f5f5 100%);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            border: 2px solid #eee;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-card .number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
        }

        .stat-card .label {
            font-size: 0.75rem;
            color: #666;
        }

        .stat-card.work {
            border-bottom: 4px solid #27ae60;
        }

        .stat-card.late {
            border-bottom: 4px solid #f39c12;
        }

        .stat-card.absent {
            border-bottom: 4px solid #e74c3c;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-family: 'Kanit', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(180deg, #4CAF50 0%, #388E3C 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
        }

        .mode-btn:not(.active) {
            background: #e0e0e0;
            color: #666;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-input {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: 2px solid #ccc;
            border-radius: 25px;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            background: white;
        }

        .filter-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.primary {
            background: linear-gradient(180deg, #4CAF50 0%, #388E3C 100%);
            color: white;
        }

        .filter-btn.secondary {
            background: linear-gradient(180deg, #9E9E9E 0%, #757575 100%);
            color: white;
        }

        /* Activity List */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #666;
        }

        .live-dot {
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.3);
            }
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(180deg, #fff 0%, #f8f8f8 100%);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid #eee;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .activity-item .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 12px;
        }

        .activity-item .status-icon.in {
            background: linear-gradient(180deg, #66BB6A 0%, #388E3C 100%);
        }

        .activity-item .status-icon.out {
            background: linear-gradient(180deg, #EF5350 0%, #C62828 100%);
        }

        .activity-item .info {
            flex: 1;
        }

        .activity-item .name {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
        }

        .activity-item .action {
            font-size: 0.8rem;
            color: #888;
        }

        .activity-item .time {
            font-size: 1.1rem;
            font-weight: 700;
            color: #00838F;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 0.85rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }

        /* Registration Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-header img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #4CAF50;
            margin-bottom: 10px;
        }

        .employee-list {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .employee-item {
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .employee-item:hover {
            border-color: #4CAF50;
            background: #f0fff0;
        }

        .employee-item.selected {
            border-color: #4CAF50;
            background: #c8e6c9;
        }

        .modal-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 25px;
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(180deg, #4CAF50 0%, #388E3C 100%);
            color: white;
        }

        .modal-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        @media (max-width: 500px) {
            .card-3d {
                padding: 20px 15px;
            }

            .clock {
                font-size: 24px;
            }

            .stat-card .number {
                font-size: 1.5rem;
            }

            .stats-grid {
                gap: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="card-3d">
            <div class="header">
                <img src="/logo.png" alt="Logo" class="logo" onerror="this.style.display='none'">
                <h1>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h1>
                <div class="subtitle">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡πà‡∏≤‡πÉ‡∏´‡∏ç‡πà</div>
                <div class="clock" id="currentTime">--:--:--</div>
            </div>

            <!-- Profile Card (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ login + ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß) -->
            <div id="profileCard" class="profile-card hidden">
                <img id="profilePicture" src="" alt="Profile">
                <div class="info">
                    <h2 id="profileName">-</h2>
                    <p>üìÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ <span id="registeredAt">-</span></p>
                </div>
            </div>

            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button class="mode-btn active" id="btnPersonal" onclick="switchMode('personal')">üë§
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                <button class="mode-btn" id="btnAll" onclick="switchMode('all')">üë• ‡∏î‡∏π‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</button>
            </div>
        </div>

        <!-- Personal Dashboard -->
        <div id="personalDashboard" class="card-3d">
            <h3 style="margin-bottom: 15px;">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <div class="stats-grid">
                <div class="stat-card work">
                    <div class="number" id="statWork">-</div>
                    <div class="label">‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                </div>
                <div class="stat-card late">
                    <div class="number" id="statLate">-</div>
                    <div class="label">‡∏°‡∏≤‡∏™‡∏≤‡∏¢</div>
                </div>
                <div class="stat-card absent">
                    <div class="number" id="statAbsent">-</div>
                    <div class="label">‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô</div>
                </div>
            </div>

            <div class="section-header">
                <h2>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h2>
            </div>
            <div class="activity-list" id="personalHistory">
                <!-- History items -->
            </div>
        </div>

        <!-- All Status (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
        <div id="allDashboard" class="card-3d hidden">
            <!-- Filters -->
            <div class="filters">
                <input type="text" class="filter-input" id="nameFilter" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠...">
                <input type="date" class="filter-input" id="dateFilter" style="max-width: 150px;">
            </div>
            <div class="filters">
                <button class="filter-btn primary" onclick="loadAllData()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                <button class="filter-btn secondary" onclick="resetFilters()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
            </div>

            <div class="section-header">
                <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    <span>Live</span>
                </div>
            </div>
            <div class="activity-list" id="allActivityList">
                <!-- Activity items -->
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">-</span>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <img id="modalProfilePic" src="" alt="Profile">
                <h2>üîó ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE</h2>
                <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ <strong id="modalLineName">-</strong><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>
            <input type="text" class="filter-input" id="searchEmployee" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..."
                style="width:100%; margin-bottom:15px;" oninput="filterEmployees()">
            <div class="employee-list" id="employeeList">
                <!-- Employee items -->
            </div>
            <button class="modal-btn" id="btnRegister" onclick="registerLine()" disabled>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        const REFRESH_INTERVAL = 10000;

        let lineProfile = null;
        let lineUserId = null;
        let isRegistered = false;
        let employeeData = null;
        let currentMode = 'personal';
        let selectedEmployee = null;
        let allEmployees = [];
        let refreshTimer = null;

        // ========== Initialization ==========
        document.addEventListener('DOMContentLoaded', async () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFilter').value = today;

            updateClock();
            setInterval(updateClock, 1000);

            await initLiff();
        });

        async function initLiff() {
            try {
                // Try to get LIFF ID from server config
                const configRes = await fetch(`${API_BASE_URL}/api/config`);
                if (configRes.ok) {
                    const config = await configRes.json();
                    if (config.liffId) {
                        await liff.init({ liffId: config.liffId });

                        if (liff.isLoggedIn()) {
                            lineProfile = await liff.getProfile();
                            lineUserId = lineProfile.userId;
                            console.log('LINE Profile:', lineProfile.displayName);

                            await checkRegistration();
                        } else {
                            // ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login LINE - ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏´‡∏°‡∏î All
                            showAllMode();
                        }
                    } else {
                        showAllMode();
                    }
                } else {
                    showAllMode();
                }
            } catch (error) {
                console.log('LIFF init error:', error);
                showAllMode();
            }
        }

        async function checkRegistration() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/check-registration?line_user_id=${lineUserId}`);
                const result = await res.json();

                if (result.success && result.isRegistered) {
                    isRegistered = true;
                    employeeData = result.employee;
                    showPersonalDashboard();
                } else {
                    // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô - ‡πÅ‡∏™‡∏î‡∏á Modal
                    showRegisterModal();
                }
            } catch (error) {
                console.error('Check registration error:', error);
                showAllMode();
            }
        }

        function showRegisterModal() {
            if (lineProfile) {
                document.getElementById('modalProfilePic').src = lineProfile.pictureUrl || '/logo.png';
                document.getElementById('modalLineName').textContent = lineProfile.displayName;
            }
            loadUnlinkedEmployees();
            document.getElementById('registerModal').classList.add('show');
        }

        async function loadUnlinkedEmployees() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/employees/unlinked`);
                const result = await res.json();

                if (result.success) {
                    allEmployees = result.data;
                    renderEmployeeList(allEmployees);
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        function renderEmployeeList(employees) {
            const container = document.getElementById('employeeList');
            if (employees.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div></div>';
                return;
            }

            container.innerHTML = employees.map(emp => `
                <div class="employee-item" data-name="${escapeHtml(emp.name)}" onclick="selectEmployee(this, '${escapeHtml(emp.name)}')">
                    ${escapeHtml(emp.name)}
                </div>
            `).join('');
        }

        function filterEmployees() {
            const query = document.getElementById('searchEmployee').value.toLowerCase();
            const filtered = allEmployees.filter(e => e.name.toLowerCase().includes(query));
            renderEmployeeList(filtered);
        }

        function selectEmployee(el, name) {
            document.querySelectorAll('.employee-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedEmployee = name;
            document.getElementById('btnRegister').disabled = false;
        }

        async function registerLine() {
            if (!selectedEmployee || !lineUserId) return;

            try {
                const res = await fetch(`${API_BASE_URL}/api/register-line`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_name: selectedEmployee,
                        line_user_id: lineUserId,
                        line_name: lineProfile?.displayName || '',
                        line_picture: lineProfile?.pictureUrl || ''
                    })
                });

                const result = await res.json();

                if (result.success) {
                    document.getElementById('registerModal').classList.remove('show');
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${selectedEmployee}`,
                        timer: 2000,
                        showConfirmButton: false
                    });

                    employeeData = { name: selectedEmployee };
                    isRegistered = true;
                    showPersonalDashboard();
                } else {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.error, 'error');
                }
            } catch (error) {
                console.error('Register error:', error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
            }
        }

        // ========== Dashboard Functions ==========

        function showPersonalDashboard() {
            document.getElementById('profileCard').classList.remove('hidden');
            document.getElementById('personalDashboard').classList.remove('hidden');
            document.getElementById('allDashboard').classList.add('hidden');
            document.getElementById('btnPersonal').classList.add('active');
            document.getElementById('btnAll').classList.remove('active');

            // Set profile
            if (lineProfile) {
                document.getElementById('profilePicture').src = lineProfile.pictureUrl || '/logo.png';
            }
            if (employeeData) {
                document.getElementById('profileName').textContent = employeeData.name;
                document.getElementById('registeredAt').textContent = employeeData.registeredAt || '-';
            }

            loadPersonalData();
            startAutoRefresh('personal');
        }

        function showAllMode() {
            document.getElementById('profileCard').classList.add('hidden');
            document.getElementById('personalDashboard').classList.add('hidden');
            document.getElementById('allDashboard').classList.remove('hidden');
            document.getElementById('btnPersonal').classList.remove('active');
            document.getElementById('btnAll').classList.add('active');

            loadAllData();
            startAutoRefresh('all');
        }

        function switchMode(mode) {
            currentMode = mode;
            if (mode === 'personal' && isRegistered) {
                showPersonalDashboard();
            } else {
                showAllMode();
            }
        }

        async function loadPersonalData() {
            if (!lineUserId) return;

            try {
                // Load stats
                const statsRes = await fetch(`${API_BASE_URL}/api/my/stats?line_user_id=${lineUserId}`);
                const statsResult = await statsRes.json();

                if (statsResult.success) {
                    document.getElementById('statWork').textContent = statsResult.data.workDays || 0;
                    document.getElementById('statLate').textContent = statsResult.data.lateDays || 0;
                    document.getElementById('statAbsent').textContent = statsResult.data.absentDays || 0;
                }

                // Load history
                const historyRes = await fetch(`${API_BASE_URL}/api/my/history?line_user_id=${lineUserId}&limit=10`);
                const historyResult = await historyRes.json();

                if (historyResult.success) {
                    renderPersonalHistory(historyResult.data);
                }

                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('th-TH');
            } catch (error) {
                console.error('Error loading personal data:', error);
            }
        }

        function renderPersonalHistory(records) {
            const container = document.getElementById('personalHistory');

            if (!records || records.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div></div>';
                return;
            }

            container.innerHTML = records.map(r => `
                <div class="activity-item">
                    <div class="status-icon in">üü¢</div>
                    <div class="info">
                        <div class="name">${escapeHtml(r.date)}</div>
                        <div class="action">‡πÄ‡∏Ç‡πâ‡∏≤: ${r.clockInTime || '-'} | ‡∏≠‡∏≠‡∏Å: ${r.clockOutTime || '-'}</div>
                    </div>
                    <div class="time">${r.workingHours ? r.workingHours.toFixed(1) + ' ‡∏ä‡∏°.' : '-'}</div>
                </div>
            `).join('');
        }

        async function loadAllData() {
            try {
                const name = document.getElementById('nameFilter').value.trim();
                const dateInput = document.getElementById('dateFilter').value;

                let date = null;
                if (dateInput) {
                    const [year, month, day] = dateInput.split('-');
                    date = `${day}/${month}/${year}`;
                }

                const params = new URLSearchParams();
                if (name) params.append('name', name);
                if (date) params.append('date', date);
                params.append('limit', '30');

                const res = await fetch(`${API_BASE_URL}/api/status/live?${params}`);
                const result = await res.json();

                if (result.success) {
                    renderAllActivity(result.data.records);
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('th-TH');
                }
            } catch (error) {
                console.error('Error loading all data:', error);
            }
        }

        function renderAllActivity(records) {
            const container = document.getElementById('allActivityList');

            if (!records || records.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>';
                return;
            }

            container.innerHTML = records.map(r => `
                <div class="activity-item">
                    <div class="status-icon ${r.type}">${r.type === 'in' ? 'üü¢' : 'üî¥'}</div>
                    <div class="info">
                        <div class="name">${escapeHtml(r.employee)}</div>
                        <div class="action">${r.type === 'in' ? 'üì• ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤' : 'üì§ ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å'}</div>
                    </div>
                    <div class="time">${r.timeOnly || '-'}</div>
                </div>
            `).join('');
        }

        function resetFilters() {
            document.getElementById('nameFilter').value = '';
            document.getElementById('dateFilter').value = new Date().toISOString().split('T')[0];
            loadAllData();
        }

        // ========== Utilities ==========

        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('th-TH');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function startAutoRefresh(mode) {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                if (mode === 'personal') loadPersonalData();
                else loadAllData();
            }, REFRESH_INTERVAL);
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (refreshTimer) clearInterval(refreshTimer);
            } else {
                if (currentMode === 'personal') loadPersonalData();
                else loadAllData();
                startAutoRefresh(currentMode);
            }
        });
    </script>
</body>

</html>